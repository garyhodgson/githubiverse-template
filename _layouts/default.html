<!doctype html>
<html>
  <head>
    <title>Githubiverse: {{ page.title }} by {{ page.author }}</title>

    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    
    <link href="css/bootstrap/bootstrap.css" rel="stylesheet">
    <link href="css/lightbox/lightbox.css" rel="stylesheet" />
    <link href="css/githubiverse/default.css" rel="stylesheet" media="screen" type="text/css">

  </head>
  <body>
    {% if page.show_forkme_ribbon %}
      <a href="{{page.github.base}}{{page.github.user}}/{{page.github.repository}}"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
    {% endif %}

    <div class="container">
      <div class="row-fluid">
        <div class="span12">

          {% include header.html %}

          <div class="page-header">
            <h1 id="title">{{ page.title }}<small> by {{ page.author }}</small></h1>
          </div>
          
          <div class="row-fluid">
            <div class="span6">

              <div id="lead-image-container"></div>

              <ul id='thumbnails' class='thumbnails'></ul>


              <h3>Sources</h3>
              <div id="sources-section">
                <div class="row-fluid">
                  <div class="span9">
                    <ul id="sources" class="nav nav-tabs nav-stacked"></ul>
                  </div>
                  <div class="span3">
                    <ul id="sourcedownloads" class="nav nav-tabs nav-stacked"></ul>
                  </div>
                </div>
              </div>

            </div>

            <div class="span6">
              
              <div id="description">
                {{ content }}
              </div>

              <div class="meta row-fluid">
                <div class="span12">
                  <div id="tags">
                    <i class="icon-tags" title="tags"></i>&nbsp;
                    {% for tag in page.tags %}
                      <a href="#" class="tag"><span class="label">{{ tag }}</span></a>
                    {% endfor %}
                  </div>
                </div>
              </div>

              <div class="meta row-fluid">
                <div class="span6">
                  <div id="home"><i class='icon-home' title="Repository"></i>&nbsp;<a href="{{ page.github.base }}{{ page.github.repository }}">{{ page.github.repository }}</a></div>
                </div>

                <div class="span6">
                  <div id="author"><i class='icon-user' title="User"></i>&nbsp;<a href="{{ page.github.base }}{{ page.github.user }}">{{ page.github.user }}</a></div>
                </div>
              </div>

              <div class="meta row-fluid">
                <div class="span6">
                  <div id="license"><i class='icon-file' title="License"></i>&nbsp;{{ page.license }}</div>
                </div>
                <div class="span6">
                  <div id="download-all"><i class='icon-download' title="Download Project"></i>&nbsp;<a href="{{ page.github.base }}{{ page.github.user }}/{{ page.github.repository }}/zipball/{{ page.github.branch }}">Download Project as Zip</a></div>
                </div>
              </div>

              <div class="meta row-fluid">
                <div class="span6">
                  <div id="created"><i class='icon-play-circle' title="Created"></i>&nbsp;Created: </div>
                </div>
                <div class="span6">
                  <div id="updated"><i class='icon-refresh' title="Updated"></i>&nbsp;Updated: </div>
                </div>
              </div>              

              <h3>STLs</h3>
              <div id="stlviewer"></div>
              <div id="stls-section">
                <div class="row-fluid">
                  <div class="span9">
                    <ul id="stls" class="nav nav-tabs nav-stacked"></ul>
                  </div>
                  <div class="span3">
                    <ul id="stldownloads" class="nav nav-tabs nav-stacked"></ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% include footer.html %}

        </div>
      </div>
    </div>

    <!-- Javascript -->

    <script src="http://code.jquery.com/jquery-1.8.1.min.js"> </script>
    <script src="js/prettydate.js"> </script>
    <script src="js/bootstrap/bootstrap.min.js"></script>
    <script src="js/lightbox/lightbox.min.js"></script>
    <script src="js/thingiview/Three.js"></script>
    <script src="js/thingiview/plane.js"></script>
    <script src="js/thingiview/thingiview.min.js"></script>
    <script src="js/underscore/underscore.min.js"></script>
    <script src="js/github/gh3.min.js"></script>
    
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script>
      $(document).ready(function(){
        autoloadSTL = {{ page.autoload_stl }};
        leadImageName = '{{ page.lead_image }}';
        showLeadImage = {{ page.show_lead_image }};
        thingiurlbase = "js/thingiview";
        thingiview = new Thingiview("stlviewer");
        thingiview.setObjectColor('#C0D8F0');
        thingiview.setBackgroundColor('#ffffff');
        thingiview.initScene();

        $('.stlfile').live('click', function(e){
          loadStlString($(this).data('githubFile'));
        });

        var githubUser = new Gh3.User("{{page.github.user}}"),
            githubRepositories = new Gh3.Repositories(githubUser),
            stl_file_count = 0,
            src_file_count = 0;

        function no_stls() {
          $('#stls-section').html('No STL Files Found.');
        }

        function no_sources() {
          $('#sources-section').html('No Source Files Found.');
        }

        function add_source_dir(dir, dirname){
          dir.fetchContents(function (err, res) {
            if(err) { throw "Error fetching contents for sources." }

            if (dirname == ''){
              dirname = dir.name; 
            } else {
              dirname = dirname+'/'+dir.name;
            }
                
            dir.eachContent(function (content) {
              if (content.type == 'file'){
                add_source_file(content, dirname);
              } else if (content.type == 'dir'){
                add_source_dir(content, dirname);
              }
            });
          });
        }

        function add_source_file(content,dirname){
          src_file_count++;
          if (dirname != ''){
            dirname = dirname+'/';
          }

          var fileGithubUrl = githubRepo.html_url + '/blob/' + content.branchName + '/' + content.path;
          var rawFileURL = githubRepo.html_url + '/raw/' + content.branchName + '/' + content.path;
          $('#sources').append("<li><a href='" + fileGithubUrl + "' target='_githubiverse' title='View in Github' class=\"srcfile\">"+ dirname + content.name + "</a></li>");
          $('#sourcedownloads').append("<li><a class='btn-small btn-inverse' href='" + rawFileURL + "' download='" + content.name + "'><i class='icon-download-alt icon-white'></i>&nbsp;Download</a></li>");
        }

        function add_stl_dir(dir, dirname){
          dir.fetchContents(function (err, res) {
            if(err) { throw "Error fetching contents for stls." }

            if (dirname == ''){
              dirname = dir.name; 
            } else {
              dirname = dirname+'/'+dir.name;
            }
                
            dir.eachContent(function (content) {
              if (content.type == 'file'){
                add_stl_file(content, dirname);
              } else if (content.type == 'dir'){
                add_stl_dir(content, dirname);
              }
            });
          });
        }

        function add_stl_file(content,dirname){
          if (! /\.stl$/i.test(content.name)) {
            return
          }
          stl_file_count++;
          if (dirname != ''){
            dirname = dirname+'/';
          }

          var rawFileURL = githubRepo.html_url + '/raw/' + content.branchName + '/' + content.path;
          $('#stls').append("<li><a href=\"javascript://\" title='Preview' class=\"stlfile\">"+ dirname + content.name+"</a></li>")
          $('.stlfile').last().data("githubFile",content);
          $('#stldownloads').append("<li><a class='btn-small btn-inverse' href='" +  rawFileURL + "' download='" + content.name + "'><i class='icon-download-alt icon-white'></i>&nbsp;Download</a></li>");
        }

        function loadStlString(githubFile){
          if (githubFile == undefined || githubFile == '') return;
          
          thingiview.progressBarMessage('Retrieving File Data');

          githubFile.fetchContent(function (err, res) {
            if(err) { throw "Error retrieving github file contents." }

            thingiview.loadSTLString(githubFile.getRawContent());
          });
        }

        function showImages(imgDir){
          if (imgDir != undefined){
            imgDir.fetchContents(function (err, res) {
              if(err) { throw "Error fetching contents for images." }
              imgDir.eachContent(function (content) {
                if (content.type == 'file'){
                  var rawFileURL = githubRepo.html_url + '/raw/' + content.branchName + '/' + content.path;

                  if (showLeadImage && content.name == leadImageName){
                    $('#lead-image-container').append("<a class='thumbnail' href='" + rawFileURL + "' rel='lightbox[githubiverse]'><img class='lead-image' src='" + rawFileURL + "' alt='" + content.name + "' title='" + content.name + "' /></a>");
                  } else {
                    $('#thumbnails').append("<li><a class='thumbnail' href='" + rawFileURL + "' rel='lightbox[githubiverse]'><img class='imgfile' src='" + rawFileURL + "' alt='" + content.name + "' title='" + content.name + "' /></a></li>");
                  }
                }
              });
            });
          }
        }

        function showSources(srcDir){
          if (srcDir == undefined) {
            no_sources();
            return;
          }
          srcDir.fetchContents(function (err, res) {
            if(err) { throw "Error fetching contents for sources." }
            srcDir.eachContent(function (content) {
              if (content.type == 'file'){
                add_source_file(content, '');
              } else if (content.type == 'dir'){
                add_source_dir(content, '');
              }
            });

            if (src_file_count == 0){
              no_sources();
            }
          });
        }

        function showSTLs(stlDir){
          if (stlDir == undefined){
            no_stls();
            return;
          } 
          stlDir.fetchContents(function (err, res) {
            if(err) { throw "Error fetching contents for stls." }

            stlDir.eachContent(function (content) {
                if (content.type == 'file'){
                  add_stl_file(content, '');
                } else if (content.type == 'dir'){
                  add_stl_dir(content, '');
                }
            });

            if (stl_file_count > 0){
              if (autoloadSTL && $('.stlfile').first().text() != "") {
                if ($('.stlfile').first().data('githubFile') != undefined){
                  loadStlString($('.stlfile').first().data('githubFile'));  
                }                      
              }  
            } else {
              no_stls();
            }
          });
        }

        function getDirRecursive(path, parentDir,callback) {

          parentDir.fetchContents(function (err, res) {
            if(err) { throw "Error fetching contents for images." }

            if (path.indexOf("/") == -1){
              callback(parentDir.getDirByName(path));
              return
            }

            var nextDirName = path.substring(0, path.indexOf("/"));
            var currentDir = parentDir.getDirByName(nextDirName);
            var remainingPath = path.substring(path.indexOf("/")+1);

            return getDirRecursive(remainingPath, currentDir,callback);
          });        
        }

        function processDirectories(path, callback){
          
          if (path.indexOf("/") == -1){
            var dir = master.getDirByName(path)
            if (dir == undefined){
              console.error("Unable to find directory in branch: ", path);
              callback(null);
              return false
            }
            callback(dir);
          } else {
            var nextDirName = path.substring(0, path.indexOf("/"));
            var nextDir = master.getDirByName(nextDirName);
            if (nextDir == undefined){
              console.error("Unable to find directory in branch: ", nextDir);
              callback(null);
              return false
            }
            var remainingPath = path.substring(path.indexOf("/")+1);
            getDirRecursive(remainingPath, nextDir, callback);
          }
        }

        githubRepositories.fetch({page:1, per_page:100, direction : "desc"},"next", function (err, res) {
          if(err) { throw "Error fetching github repositories." }
        });

        githubRepo = new Gh3.Repository("{{page.github.repository}}", githubUser);
        githubRepo.fetch(function (err, res) {
          if(err) { throw "Error fetching github repository." }

          githubRepo.fetchBranches(function (err, res) {
            if(err) { throw "Error fetching github branches." }

            master = githubRepo.getBranchByName("{{page.github.branch}}");

            master.fetchContents(function (err, res) {
              if(err) { throw "Error fetching github repository contents." }

              processDirectories('{{ page.src_dir }}', showSources);
              processDirectories('{{ page.img_dir }}', showImages);
              processDirectories('{{ page.stl_dir }}', showSTLs);

              $('#updated').append("&nbsp;"+prettyDate(githubRepo.updated_at));
              $('#created').append("&nbsp;"+prettyDate(githubRepo.created_at));

              {% if page.description_file %}
                
                var descriptionFile = master.getFileByName('{{page.description_file}}');
                descriptionFile.fetchContent(function (err, res) {
                  if(err) { throw "Error retrieving github description file." }

                  if ($('#description').html().trim() == ''){
                    $('#description').html(descriptionFile.getRawContent().replace(/\n/g,'<br>'));  
                  } else {
                    var descriptionText = $('#description').html() + "<br>"  + descriptionFile.getRawContent().replace(/\n/g,'<br>');
                    $('#description').html(descriptionText);
                  }
                  
                  
                });
                
              {% endif %}

            });

          })
        });


      });

    </script>
  </body>
</html>